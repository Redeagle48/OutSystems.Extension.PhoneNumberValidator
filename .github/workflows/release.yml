name: Build and Package Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'

permissions:
  contents: read

env:
  PROJECT_NAME: OutSystems.PhoneNumberValidator
  PRODUCT_NAME: PhoneNumberValidator

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    # 1. Restore the solution (or both projects) for the target runtime
    - name: Restore dependencies
      run: dotnet restore ${{ env.PROJECT_NAME }}/${{ env.PROJECT_NAME }}.sln -r linux-x64

     # --- THE GATEKEEPER: RUN TESTS ---

    - name: Run tests
      run: |
          dotnet test ${{ env.PROJECT_NAME }}.UnitTests/${{ env.PROJECT_NAME }}.UnitTests.csproj \
            --configuration Release \
            --no-restore \
            --nologo \
            --collect:"XPlat Code Coverage" \
            --results-directory ./coverage

    - name: Report Code Coverage (Optional Summary)
      uses: irongut/CodeCoverageSummary@v1.3.0
      with:
        filename: coverage/**/coverage.cobertura.xml
        badge: true
        format: markdown
        output: both

    - name: Write coverage to summary
      run: cat code-coverage-results.md >> $GITHUB_STEP_SUMMARY

    # --- PACKAGING STEPS (Only runs if tests pass) ---

    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Publish App
      run: |
          dotnet publish ${{ env.PROJECT_NAME }}/${{ env.PROJECT_NAME }}.csproj \
            -c Release \
            -r linux-x64 \
            --self-contained false \
            --no-restore \
            -o ./publish

    - name: Create Versioned Zip
      run: |
          cd ./publish
          zip -r ../${{ env.PRODUCT_NAME }}_${{ steps.version.outputs.VERSION }}.zip .
          cd ..

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
          files: ${{ env.PRODUCT_NAME }}_${{ steps.version.outputs.VERSION }}.zip
          name: Release ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
